<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="stylesheet" href="/css/styles.css"/>
  </head>
  <body>
    <header>
      <nav>
        <ol class="logo">
          <li>
            <a href="/">
              <img src="/media/brightdigit-name.svg"/>
            </a>
          </li>
        </ol>
        <ol class="menu">
          <li>
            <a href="/services">Services</a>
          </li>
          <li>
            <a href="/products">Products</a>
          </li>
          <li>
            <a href="/articles">Articles</a>
          </li>
          <li>
            <a href="/development">Development</a>
          </li>
        </ol>
        <ol class="menu">
          <li>
            <a href="/podcast">Podcast</a>
          </li>
          <li>
            <a href="/newsletters">Newsletters</a>
          </li>
          <li>
            <a href="/sponsorship">Sponsorship</a>
          </li>
          <li>
            <a href="/about">About</a>
          </li>
        </ol>
        <ol class="more">
          <li>
            <a href="/#menu">Menu</a>
          </li>
        </ol>
      </nav>
    </header>
    <main>
      <article>
        <div class="content"><p>It can be a real challenge <a href="https://share.transistor.fm/s/ffcb9fc1?utm_source=learning-swift&utm_medium=web">picking the right back end</a> for your mobile app. For instance, Swift developers don't have anything without needing to run on another language. Therefore, I decided to do <a href="https://learningswift.brightdigit.com/vapor-swift-backend-review/?utm_medium=web&utm_source=learning-swift">a review of Vapor</a> and whether it is really a right choice.</p><p><strong>What I found was that for Swift developers,</strong> <a href="https://vapor.codes"><strong>Vapor</strong></a> <strong>is a really great choice and fairly easy to work with</strong>. In addition, Vapor has an effective community and a great API if your development team is dedicated to Swift. Therefore, rather than having your team hop from Xcode and Swift to VSCode or Firebase etc...</p><p>In this article I am going to cover how to get started, specifically:</p><ul><li><strong><a href="#macos-dev">Setup your Mac for Vapor Development</a></strong></li><li>Convert your project to <strong><a href="#macos-postgresql">use PostgreSQL Database</a></strong></li><li>Modify your project for <strong><a href="#heroku-vapor">Heroku Deployment</a></strong></li><li>Prepare an <strong><a href="#ubuntu-vapor">Ubuntu Server for Vapor</a></strong></li><li>Modify your project for <strong><a href="#ubuntu-code">Ubuntu deployment</a></strong></li></ul><p>As a result, you'll have fully working backend with Postgres ready and easily deployable.</p><p>::: {#mc<em>embed</em>signup} ::: {#mc<em>embed</em>signup_scroll}</p><h2>Want to Learn More? Get the Full Guide and Video Mini-Course Today</h2><p>::: {.indicates-required} [*]{.asterisk} indicates required :::</p><p>::: {.mc-field-group} Email Address [*]{.asterisk} :::</p><p>::: {.mc-field-group} First Name [*]{.asterisk} :::</p><p>::: {.mc-field-group} Last Name [*]{.asterisk} :::</p><p>::: {.mc-field-group .input-group style="display:none"} - Swift - Productivity - Vapor :::</p><p>::: {.mc-field-group .input-group style="display:none"} <strong>Products</strong></p><ul><li>Speculid :::</li></ul><p>::: {#mergeRow-gdpr .mergeRow .gdpr-mergeRow .content<strong>gdprBlock .mc-field-group} ::: {.content</strong>gdpr} Marketing Permissions</p><p>Please select all the ways you would like to hear from BrightDigit:</p><p>Email</p><p>You can unsubscribe at any time by clicking the link in the footer of our emails. For information about our privacy practices, please visit our website. :::</p><p>::: {.content__gdprLegal} We use Mailchimp as our marketing platform. By clicking below to subscribe, you acknowledge that your information will be transferred to Mailchimp for processing. <a href="https://mailchimp.com/legal/">Learn more about Mailchimp's privacy practices here.</a> ::: :::</p><p>::: {#mce-responses .clear} ::: {#mce-error-response .response style="display:none"} :::</p><p>::: {#mce-success-response .response style="display:none"} ::: :::</p><p>::: {style="position: absolute; left: -5000px;" aria-hidden="true"} :::</p><p>::: {.clear} ::: ::: :::</p><h2>Setting Up Your Mac For Vapor Development {#macos-dev}</h2><p>In order to start developing a Vapor application, we'll need to setup our Mac. According to the Vapor docs, <strong>you need Xcode 9.3 or greater</strong>. However for this tutorial, I used the latest version of macOS and Xcode at the time of writing:</p><ul><li>macOS <strong>Mojave 10.14.3</strong></li><li>Xcode <strong>10.1</strong></li></ul><h3>Prerequisites For Vapor</h3><p>I also have installed <strong><a href="https://brew.sh/">Homebrew</a></strong>. To install Homebrew, open your terminal application and type:</p><pre><code>/usr/bin/ruby -e <span class="string">"$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"</span>`
</code></pre><p>For more details you can go to <strong><a href="https://brew.sh/">the official Homebrew home page</a></strong>.</p><h3>Installing Vapor</h3><p>Once you have Homebrew installed we can go ahead and install <strong>Vapor</strong> on your Mac. Before we proceed, we'll need to add the Vapor repository to Homebrew.</p><p>::: {.wp-block-embed__wrapper} https://m.youtube.com/watch?v=yYCxa6ev1Ng :::</p><ol><li>Firstly, <strong>add the Vapor repository</strong> using the <code>tap</code> command:</li></ol><pre><code>brew tap vapor/tap
</code></pre><ol start="2"><li>Next, <strong>install the Vapor toolkit</strong>:</li></ol><pre><code>brew install vapor/tap/vapor
</code></pre><p>As a result of installing the Vapor toolkit, <strong>we'll have access to the Vapor CLI tool</strong>. Therefore, you can get access to the list of commands available by typing:</p><pre><code>vapor --help
</code></pre><p>For example, <strong>with the Vapor CLI tool</strong>, you can:</p><ul><li><strong>Build</strong> the application</li><li><strong>Run</strong> the application</li><li>setup for <strong>Heroku</strong> deployment later</li><li>Create the <strong>Xcode</strong> project and of course...</li><li>Create the <strong>new</strong> Swift package</li></ul><h3>Creating Your First Vapor Project</h3><p>::: {.wp-block-embed__wrapper} https://m.youtube.com/watch?v=iZqHmFnisXQ :::</p><p>Therefore, <strong>we can create the Switch package which will contain the dependencies needed to run our server application</strong> with the command:</p><pre><code>vapor new app-collection
</code></pre><p>Additionally, <strong>we can create an Xcode project</strong> from our Vapor application Swift package by typing:</p><pre><code>vapor xcode
</code></pre><p>As a result, we can open the newly created Xcode project.</p><img src="https://learningswift.brightdigit.com/wp-content/uploads/sites/2/2019/03/macos_xcode_switch_target.jpg" alt="Switching the target to <em>Run</em>"/><p>{.wp-image-514}</p><img src="https://learningswift.brightdigit.com/wp-content/uploads/sites/2/2019/03/macos_xcode_run.jpg" alt="Building and running the <em>Run</em> target"/><p>{.wp-image-515}</p><p>::: {.wp-block-embed__wrapper} https://www.youtube.com/watch?v=kZKP2MiFaLQ :::</p><p>After that, switch the target in the top left to <em>Run</em> and press the <em>play button</em> to run the application. Consequently, you should see a log message at the bottom stating that a http server is started at port 8080.</p><p>As a result, go to the terminal and run the command:</p><pre><code>curl http://localhost:<span class="number">8080</span>/hello
</code></pre><p>Therefore, you should receive the message:</p><pre><code><span class="type">Hello</span>, world!%
</code></pre><p>::: {.wp-block-embed__wrapper} https://m.youtube.com/watch?v=bRXTT8K-lP8 :::</p><p>In conclusion, we've successfully used the provided Vapor templates with the <em>new</em> and <em>xcode</em> commands to create the Swift package and build the application in Xcode. However the application only used SQLite for our database storage. Instead, let's switch to using a more common database: PostgreSQL.</p><h2>Setting Up For PostgreSQL {#macos-postgresql}</h2><p>PostgreSQL has been my favorite relational SQL based database server. As a result, we are going to look at converting the current Vapor project to use PostgreSQL rather than the default SQLite.</p><p>Therefore, make sure you already have PostgreSQL installed. Consequently, if you don't you can use Homebrew to install PostgreSQL with the following command:</p><pre><code>brew install postgresql
</code></pre><p>::: {.wp-block-embed__wrapper} https://www.youtube.com/watch?v=KeLHTQrZXNI :::</p><p>Further, to run the server from the Terminal:</p><pre><code>pg_ctl -<span class="type">D</span> /usr/local/<span class="keyword">var</span>/postgres start
</code></pre><p>Similarly, you can stop the server from the Terminal with:</p><pre><code>pg_ctl -<span class="type">D</span> /usr/local/<span class="keyword">var</span>/postgres stop
</code></pre><p>On the other hand, if you wish to run PostgreSQL as background service with launchd you can use the <a href="https://github.com/Homebrew/homebrew-services"><code>brew services</code></a> command:</p><pre><code>brew services start postgresql
</code></pre><p>Most importantly, once PostgreSQL is started, we'll need to add the database and user for our application to use.</p><h3>Setup Database and User</h3><p>As a result of switching the PostgreSQL, we'll need to add the user and database our Vapor application will use. Therefore, let's run the PostgreSQL terminal-based front-end <a href="https://www.postgresql.org/docs/11/index.html"><code>psql</code></a> by going to the Terminal and typing:</p><pre><code>psql -d postgres
</code></pre><p>After that, at the <code>psql</code> prompt, create the database with:</p><pre><code>create database app_collection;
</code></pre><p>Likewise, we need to create a user. To clarify, we are creating a user with no password by typing:</p><pre><code>create user app_collection;
</code></pre><p>Subsequently grant that user the privileges it needs with:</p><pre><code>grant all privileges on database app_collection to app_collection;
</code></pre><p>::: {.wp-block-embed__wrapper} https://www.youtube.com/watch?v=gmKSy71PxWM :::</p><p>As a result, our database should be ready for access. However, we'll need to update the code and specifically the Swift package to use PostgreSQL.</p><h3>Updating the Code For PostgreSQL</h3><h4>Update Package.swift with PostgreSQL</h4><p>In order to use PostgreSQL in our backend application, we'll need to update the Package.swift file to use PostgreSQL as opposed to SQLite.</p><p>Therefore, open the Package.swift and update <code>dependencies</code> by changing the line from:</p><pre><code>.<span class="call">package</span>(url: <span class="string">"https://github.com/vapor/fluent-sqlite.git"</span>, from: <span class="string">"3.0.0"</span>)
</code></pre><p>to the line:</p><pre><code>.<span class="call">package</span>(url: <span class="string">"https://github.com/vapor/fluent-postgresql.git"</span>, from: <span class="string">"1.0.0"</span>)
</code></pre><p>To clarify, we'll be using <a href="https://docs.vapor.codes/3.0/fluent/getting-started/">Fluent</a>, Vapor's ORM Framework, along with PostgreSQL. In other words, we are swapping the Fluent driver for SQLite with the one for PostgreSQL. Likewise, if you can read more details on the different drivers and how their setup works in Fluent's documentation.</p><p>Consequently, we need to also update the <em>App targets</em> to use the new <em>FluentPostgreSQL</em> dependency. Therefore change the line:</p><pre><code>  .<span class="call">target</span>(name: <span class="string">"App"</span>, dependencies: [<span class="string">"FluentSQLite"</span>, <span class="string">"Vapor"</span>]),
</code></pre><p>to the line:</p><pre><code>  .<span class="call">target</span>(name: <span class="string">"App"</span>, dependencies: [<span class="string">"FluentPostgreSQL"</span>, <span class="string">"Vapor"</span>]),
</code></pre><p>::: {.wp-block-embed__wrapper} https://www.youtube.com/watch?v=j3Z1HxSMVWU :::</p><p>In addition to updating the <em>Package.swift</em> file, we need to actually update our Xcode project to use the new dependencies.</p><h4>Update Packages</h4><p>Therefore, in order to fetch and update the package with the new dependencies and update the Xcode project file, we can run the <em>xcode</em> command again with:</p><pre><code>vapor xcode
</code></pre><p>As a result, vapor has fetched the Fluent PostgreSQL driver and updated the Xcode project. Therefore, we can move forward by updating the code.</p><h4>Update the Code</h4><p>Consequently, open the update Xcode project. Since we have removed the Fluent SQLite driver, we should no longer be able to build the project. As a result we need update our models to use PostgreSQL as well as the Provider, Database, and Migration used in our configuration. Therefore, open the <em>configure.swift</em>.</p><p>Firstly, let's update the import at the top of the file from:</p><pre><code><span class="keyword">import</span> FluentSQLite
</code></pre><p>to:</p><pre><code><span class="keyword">import</span> FluentPostgreSQL
</code></pre><p>Secondly, update the provider by updating the line:</p><pre><code><span class="keyword">try</span> services.<span class="call">register</span>(<span class="type">FluentSQLiteProvider</span>())
</code></pre><p>to</p><pre><code><span class="keyword">try</span> services.<span class="call">register</span>(<span class="type">FluentPostgreSQLProvider</span>())
</code></pre><p>Further, update the database used by changing the line from:</p><pre><code><span class="comment">// Configure a SQLite database</span>
<span class="keyword">let</span> sqlite = <span class="keyword">try</span> <span class="type">SQLiteDatabase</span>(storage: .<span class="dotAccess">memory</span>)

<span class="comment">// Register the configured SQLite database to the database config.</span>
<span class="keyword">var</span> databases = <span class="type">DatabasesConfig</span>()
databases.<span class="call">add</span>(database: sqlite, as: .<span class="dotAccess">sqlite</span>)
services.<span class="call">register</span>(databases)
</code></pre><p>to:</p><pre><code><span class="comment">// Configure a PostgreSQL database</span>
<span class="keyword">let</span> postgreSQLConfig = <span class="type">PostgreSQLDatabaseConfig</span>(hostname: <span class="string">"localhost"</span>, username: <span class="string">"app_collection"</span>)
<span class="keyword">let</span> postgreSQL = <span class="type">PostgreSQLDatabase</span>(config: postgreSQLConfig)

<span class="comment">// Register the configured PostreSQL database to the database config.</span>
<span class="keyword">var</span> databases = <span class="type">DatabasesConfig</span>()
databases.<span class="call">add</span>(database: postgreSQL, as: .<span class="dotAccess">psql</span>)
services.<span class="call">register</span>(databases)
</code></pre><p>In other words, we are replacing the memory based SQLite database with the PostgreSQL local database configured with the user name <em>app</em>collection*.</p><p>To clarify, the <a href="https://api.vapor.codes/postgresql/latest/PostgreSQL/Structs/PostgreSQLDatabaseConfig.html#/s:10PostgreSQL0A17SQLDatabaseConfigVACSS8hostname_Si4portSS8usernameSSSg8databaseAG8passwordAA0A13SQLConnectionC09TransportD0V9transporttcfc"><code>PostgreSQLDatabaseConfig</code> initializer</a> can multiple parameters in this case we are using the default port number and the default database name which matches with user name, in this case <em>app</em>collection*.</p><p>Lastly, in the <em>configuration.swift</em>, update the migration for the</p><p><code>Todo</code> model. To clarify, <a href="https://docs.vapor.codes/3.0/fluent/migrations/">migrations</a> are used to create and update the tables and relationships used by Fluent. Therefore, in this case we just need to change the parameter in this line:</p><pre><code>migrations.<span class="call">add</span>(model: <span class="type">Todo</span>.<span class="keyword">self</span>, database: .<span class="dotAccess">sqlite</span>)
</code></pre><p>to this line:</p><pre><code>migrations.<span class="call">add</span>(model: <span class="type">Todo</span>.<span class="keyword">self</span>, database: .<span class="dotAccess">psql</span>)
</code></pre><p>In the same vein, we need to change the subclasses used by our model by opening <em>Todo.swift</em>. After that change the import statement at the top again and then update model subclass from:</p><pre><code><span class="keyword">final class</span> Todo: <span class="type">SQLiteModel</span> {
</code></pre><p>to</p><pre><code><span class="keyword">final class</span> Todo: <span class="type">PostgreSQLModel</span> {
</code></pre><p>::: {.wp-block-embed__wrapper} https://www.youtube.com/watch?v=EL98HVIzV9M :::</p><p>As a result, we can go ahead and run the Vapor application.</p><h3>Run the Code</h3><p>To sum up, now that have setup the PostgreSQL database on our machine, update the Swift package dependencies, and updated the code accordingly; we can build and run the Vapor application. Therefore, in Xcode, run the <em>Run</em> target again. After that, let's go to the Terminal app to test the application. For example we can run again:</p><pre><code>curl http://localhost:<span class="number">8080</span>/hello
</code></pre><p>However, we can also add a <code>Todo</code> item by running:</p><pre><code>curl -<span class="type">X POST</span> -<span class="type">H</span> <span class="string">"Content-Type: application/json"</span> -d '{<span class="string">"title"</span>: <span class="string">"example"</span>}' http://localhost:<span class="number">8080</span>/todos
</code></pre><p>Consequently, we can verify the <code>Todo</code> item was added by calling:</p><pre><code>curl http://localhost:<span class="number">8080</span>/todos
</code></pre><p>As a result, we get the JSON response:</p><pre><code>[{<span class="string">"id"</span>:<span class="number">1</span>,<span class="string">"title"</span>:<span class="string">"example"</span>}]
</code></pre><p>Subsequently, let's deploy this to the cloud. Firstly, we'll look into Heroku.</p><h2>Deploying Vapor to Heroku {#heroku-vapor}</h2><p>In addition to setting up our application for PostgreSQL, we will move forward with deploying it Heroku. Above all, Heroku offers the easiest way to get up and running. In addition, it offers enough plugins and services on its free tier that we can simply get started. Therefore, let's begin by setting up our project for Heroku.</p><h3>Preparing Vapor Package For Heroku</h3><p>Importantly, make sure you have an account setup at Heroku. After that, go to the Terminal again, and in the project directory, we can simply run the command:</p><pre><code>vapor heroku <span class="keyword">init</span>
</code></pre><p>As a result, of running the command, we have created a Heroku application and added :</p><ul><li>Created a Heroku application in your account then</li><li>Vapor buildpack for Heroku deployment</li><li>git remote for Heroku</li><li>Procfile needed for Heroku to run the application</li></ul><p>The Procfile, which you read about in <a href="https://devcenter.heroku.com/articles/procfile">the Procfile documentation</a>, contains the following line:</p><pre><code>web: <span class="type">Run</span> serve --env production --port $PORT --hostname <span class="number">0.0.0.0</span>
</code></pre><p>::: {.wp-block-embed__wrapper} https://m.youtube.com/watch?v=8piDsDi6PNo :::</p><p>Moreover when you run the command, you do not need the supply any customizations. However we will need to add PostgreSQL to our Heroku application.</p><h3>Adding PostgreSQL To Heroku Instance</h3><p>Similarly, as we have setup the Vapor application in Heroku via the Terminal, we need to add PostgreSQL to our application. Therefore, we can add the Heroku repo and install the <em>heroku</em> command with Homebrew by running:</p><pre><code>brew tap heroku/brew &amp;&amp; brew install heroku
</code></pre><p>Consequently, we can add PostgreSQL by running the command:</p><pre><code>heroku addons:create heroku-postgresql:hobby-dev
</code></pre><p>As a result of running this command, we've added a <a href="https://www.heroku.com/postgres#heroku-postgres-hobby">free <em>hobby</em> level instance of PostgreSQL</a> to our application.</p><p>::: {.wp-block-embed__wrapper} https://m.youtube.com/watch?v=rprznYi-kKQ :::</p><p>Consequently, Heroku will add an environment variable for the database called <code>DATABASE_URL</code>. Therefore, we'll need to update our code to use this.</p><h3>Update Code For Heroku PostgreSQL</h3><p>Since we have added PostgreSQL to our Heroku instance, we need to update our code to use the environment the variable for the new database url,</p><p><code>DATABASE_URL</code>. Therefore, open the <em>configure.swift</em>. After that, change the lines where we setup the database from:</p><pre><code><span class="keyword">let</span> postgreSQLConfig = <span class="type">PostgreSQLDatabaseConfig</span>(hostname: <span class="string">"localhost"</span>, username: <span class="string">"app_collection"</span>)
</code></pre><p>to:</p><pre><code><span class="keyword">let</span> postgreSQLConfig : <span class="type">PostgreSQLDatabaseConfig</span>
  
<span class="keyword">if let</span> url = <span class="type">Environment</span>.<span class="call">get</span>(<span class="string">"DATABASE_URL"</span>) {
  postgreSQLConfig = <span class="type">PostgreSQLDatabaseConfig</span>(url: url)!
} <span class="keyword">else</span> {
  postgreSQLConfig = <span class="type">PostgreSQLDatabaseConfig</span>(hostname: <span class="string">"localhost"</span>, username: <span class="string">"app_collection"</span>)
}
</code></pre><p>::: {.wp-block-embed__wrapper} https://www.youtube.com/watch?v=J7VILggBt0Q :::</p><p>As a result of changing the code, we will be checking if there is an environment variable called <code>DATABASE_URL</code>. In other words, we are using the static method<a href="https://docs.vapor.codes/3.0/getting-started/services/#environment"><code>Environment.get(_:)</code></a> to fetch the string value if it exists. Secondly, if the variable doesn't exist we assume this is being run locally and it uses the default settings. To clarify, we are using an unconditional unwrapping since we'd rather it trigger a runtime error than attempt to use the default settings. Lastly, let's move forward with deploying our application.</p><h3>Deploying Vapor Package to Heroku</h3><p>Similarly, we can deploy the application to Heroku in the terminal with one of two commands. Firstly, you can push directly with git using the command:</p><pre><code>git push heroku master
</code></pre><p>Secondly, you can push with the Vapor CLI command:</p><pre><code>vapor heroku push
</code></pre><p>In short, either command will:</p><ul><li>Firstly, push your code to the Heroku</li><li>Secondly, build the Application</li><li>Lastly, run the application (based on the command in the Procfile)</li></ul><p>::: {.wp-block-embed__wrapper} https://m.youtube.com/watch?v=J0-wLRCarzc :::</p><p>Therefore, if our application instance is called <em>damp-spire-56788</em> , we should be call our application with <code>curl</code>:</p><pre><code>&gt; curl http://damp-spire-<span class="number">56788</span>.<span class="property">herokuapp</span>.<span class="property">com</span>/hello
<span class="type">Hello</span>, world!%
&gt; curl -<span class="type">X POST</span> -<span class="type">H</span> <span class="string">"Content-Type: application/json"</span> -d '{<span class="string">"title"</span>: <span class="string">"example"</span>}' http://damp-spire-<span class="number">56788</span>.<span class="property">herokuapp</span>.<span class="property">com</span>/<span class="call">todos</span>
{<span class="string">"id"</span>:<span class="number">1</span>,<span class="string">"title"</span>:<span class="string">"example"</span>}%
&gt; curl http://damp-spire-<span class="number">56788</span>.<span class="property">herokuapp</span>.<span class="property">com</span>/todos
[{<span class="string">"id"</span>:<span class="number">1</span>,<span class="string">"title"</span>:<span class="string">"example"</span>}]%
</code></pre><p>::: {.wp-block-embed__wrapper} https://m.youtube.com/watch?v=a0IJUTOJafo :::</p><p>In short, we can setup our app for Heroku by</p><ul><li>Firstly, using the Vapor CLI to setup the instance, build pack, Procfile, and git remote</li><li>Secondly, using setting up a PostgreSQL instance in Heroku</li><li>After that, updating the code to use the environment variable for the database url to access the Heroku PostgreSQL instance</li><li>Lastly, pushing the code to Heroku and testing the application</li></ul><p>Similarly, now that we know how to deploy to Heroku, let's look at what we need to do to setup our own Ubuntu server for hosting our Vapor application.</p><h2>Setting Up Vapor For Ubuntu {#ubuntu-vapor}</h2><p>In the same way, I showed how to setup our Vapor application for Heroku; we are going to look at what is needed to setup an Ubuntu server. In this case, we are using the latest LTS version of Ubuntu which is Bionic Beaver 18.04. However, according to the <a href="https://docs.vapor.codes/3.0/install/ubuntu/">documentation</a>, Vapor does support version 14.04 (Trusty Tahr) and up including 18.10 (Cosmic Cuttlefish).</p><h3>Installing Prerequisites</h3><p>With a new server setup, we need to install several package. However, first we need add Vapor's APT repo. Therefore, on the server (as root), run the following command:</p><pre><code>eval <span class="string">"$(curl -sL https://apt.vapor.sh)"</span>
</code></pre><p>After that, we can proceed with installing the software we'll be using to setup our server:</p><ul><li><strong>git</strong> - for fetching the code of our application</li><li><strong>nginx</strong> - our http server</li><li><strong>postgresql</strong> - our database server</li><li><strong>supervisor</strong> - which is used to monitor and execute the application</li><li><strong>swift</strong> and <strong>vapor</strong> - which is used to build and run the application</li></ul><p>Therefore, we can install the application with:</p><pre><code>apt install git supervisor postgresql swift vapor nginx
</code></pre><p>::: {.wp-block-embed__wrapper} https://m.youtube.com/watch?v=Ul4hL9vP06g :::</p><h3>Setting Up the PostgreSQL Database</h3><p>Similarly to how we use the <code>DATABASE_URL</code> on Heroku, we are going to setup environment variables in Ubuntu.</p><h4>Updating the Code {#ubuntu-code}</h4><p>Therefore, open up Xcode and in our project go back to</p><p><code>configure.swift</code>. After that, between the <code>import</code> statements but before the <code>configure</code> function add a struct to store the defaults for PostgreSQL:</p><pre><code><span class="keyword">public struct</span> PostgresDefaults {
  <span class="keyword">public static let</span> hostname = <span class="string">"localhost"</span>
  <span class="keyword">public static let</span> username = <span class="string">"app_collection"</span>
  <span class="keyword">public static let</span> port = <span class="number">5432</span>
}
</code></pre><p>To clarify, this struct stores the default host name, user name, and port, we use for PostgreSQL configuration</p><p>Moreover change the line in the else statement from:</p><pre><code>postgreSQLConfig = <span class="type">PostgreSQLDatabaseConfig</span>(hostname: <span class="string">"localhost"</span>, username: <span class="string">"app_collection"</span>)
</code></pre><p>to:</p><pre><code><span class="keyword">let</span> hostname = <span class="type">Environment</span>.<span class="call">get</span>(<span class="string">"DATABASE_HOSTNAME"</span>) ?? <span class="type">PostgresDefaults</span>.<span class="property">hostname</span>
<span class="keyword">let</span> username = <span class="type">Environment</span>.<span class="call">get</span>(<span class="string">"DATABASE_USERNAME"</span>) ?? <span class="type">PostgresDefaults</span>.<span class="property">username</span>
<span class="keyword">let</span> database = <span class="type">Environment</span>.<span class="call">get</span>(<span class="string">"DATABASE_DATABASE"</span>)
<span class="keyword">let</span> password = <span class="type">Environment</span>.<span class="call">get</span>(<span class="string">"DATABASE_PASSWORD"</span>)

<span class="keyword">let</span> port : <span class="type">Int</span>

<span class="keyword">if let</span> portString = <span class="type">Environment</span>.<span class="call">get</span>(<span class="string">"DATABASE_PORT"</span>) {
  port = <span class="type">Int</span>(portString) ?? <span class="type">PostgresDefaults</span>.<span class="property">port</span>
} <span class="keyword">else</span> {
  port = <span class="type">PostgresDefaults</span>.<span class="property">port</span>
}

postgreSQLConfig = <span class="type">PostgreSQLDatabaseConfig</span>(hostname: hostname, port: port, username: username, database: database, password: password, transport: .<span class="dotAccess">cleartext</span>)
</code></pre><p>To sum up, this code fetches from the environment variables for the host name, user name, database, password, and port. Consequently, if any value is invalid or does not exist it falls back to the default setup in the <code>PostgresDefaults</code> struct or null and let's the</p><p><code>PostgreSQLDatabaseConfig</code> use its default value. Likewise, this code will still work on Heroku (with the <code>DATABASE_URL</code>) and on localhost with the defaults setup.</p><p>::: {.wp-block-embed_<em>wrapper} https://www.youtube.com/watch?v=xb3LNa</em>eADo :::</p><p>However, before we setup the environment variables for our application, we need to setup the database.</p><h4>Add Database and User</h4><p>Therefore, as root, sudo in as the <code>postgres</code> user and run <code>psql</code>:</p><pre><code>sudo -u postgres psql
</code></pre><p>After that, run the following sql statements:</p><pre><code>create database app_collection;
create user app_collection with encrypted password 'app_collection_pw';
grant all privileges on database app_collection to app_collection;
</code></pre><p>To clarify, we are creating:</p><ul><li>database named <em>app</em>collection*</li><li>user named <em>app</em>collection<em> with a password </em>app<em>collection</em>pw*</li><li>grant the user all privileges on the database, we've created</li></ul><p>::: {.wp-block-embed__wrapper} https://m.youtube.com/watch?v=hY1gOcB4XbE :::</p><p>As a result of setting up the database, we can begin to setup <em>supervisor</em>.</p><h3>Setting Up Supervisor</h3><p>Since we are using supervisor, we are going to be setting up a Linux user to run the actual application.</p><h4>Adding a Linux User</h4><p>As root user again, run the following command:</p><pre><code>adduser app_collection
</code></pre><p>To clarify, we are setting up user called <code>app_collection</code> which does not need any other metadata (Full Name, Room Number, etc...). Therefore having setup the user, let's pull and build the code.</p><h4>Pulling Repo</h4><p>Having setup the user in Linux, go ahead and super user in as the new user:</p><pre><code>su -l app_collection
</code></pre><p>After that, as the new user, clone the repo:</p><pre><code>git clone https://github.<span class="property">com</span>/brightdigit/swift-vapor-app-collection-sample.<span class="property">git</span> app
</code></pre><p>Subsequently, go to the directory and build the application:</p><pre><code>cd app
vapor build
</code></pre><p>::: {.wp-block-embed__wrapper} https://m.youtube.com/watch?v=RU3jJUe66uE :::</p><p>In short, we have cloned the code from our repo and built the application. As a result, we can move forward with configuring supervisor.</p><h4>Configuring Supervisor</h4><p>While our application will serve our Rest API and <em>nginx</em> will proxy that connection, <em>supervisor</em> will monitor and control the actual Vapor application process. Therefore, let's create a configuration for our Vapor application. In other words, as root, create a file here:</p><pre><code>/etc/supervisor/conf.<span class="property">d</span>/app_collection.<span class="property">conf</span>
</code></pre><p>After that, paste this text into the configuration file:</p><pre><code>[program:app_collection]
environment =
        <span class="type">DATABASE_PASSWORD</span>=<span class="string">"app_collection_pw"</span>,
command=vapor run --port=<span class="number">3000</span> --env=production
directory=/home/app_collection/app/
autorestart=<span class="keyword">true</span>
user=app_collection
stdout_logfile=/<span class="keyword">var</span>/log/supervisor/%(program_name)-stdout.<span class="property">log</span>
stderr_logfile=/<span class="keyword">var</span>/log/supervisor/%(program_name)-stderr.<span class="property">log</span>
</code></pre><p>To clarify:</p><ul><li>the name of this process will be <em>program:app</em>collection*</li><li>we setup an environment variable for the database password</li><li>the command is to run Vapor from our code's directory</li><li>auto restart if the app fails</li><li>run as our new user</li><li>lastly, we have setup a path for the application output and errors</li></ul><p>Subsequently, we can go ahead and update supervisor by with the following commands:</p><pre><code>supervisorctl reread
supervisorctl update
</code></pre><p>::: {.wp-block-embed__wrapper} https://m.youtube.com/watch?v=-dCqEE3L0nk :::</p><p>After that, you can test if supervisor was successful by calling the application from port 3000:</p><pre><code>curl http://localhost:<span class="number">3000</span>/hello
</code></pre><p>In short, we've setup our Vapor application in supervisor to run on port 3000 with a database password setup as an environment variable. As a result, let's setup <em>nginx</em> to proxy our application.</p><h3>Setting Up Nginx</h3><p>For our http server, we'll be using <em>nginx</em>. Most importantly, we'll be setting up a host name for our application. Therefore, we are using the nginxconfig.io to setup the config files. Consequently, you can download <a href="https://nginxconfig.io/?0.domain=app_collection.local&0.redirect=false&0.https=false&0.php=false&0.proxy&0.proxy_pass=http:%2F%2Flocalhost:3000&0.root=false">the specific <em>nginx</em> configuration</a> we are using from <a href="https://nginxconfig.io/?0.domain=app_collection.local&0.redirect=false&0.https=false&0.php=false&0.proxy&0.proxy_pass=http:%2F%2Flocalhost:3000&0.root=false "specific nginx configuration for our example"">here</a>. In addition, feel free to change host name before downloading.</p><p>After that, unzip the file:</p><pre><code>unzip nginxconfig.<span class="property">io</span>-app_collection.<span class="property">local</span>.<span class="property">zip</span>
</code></pre><p>Firstly, we can, as root, move the files to their proper locations:</p><pre><code>mv nginx.<span class="property">conf</span> /etc/nginx/nginx.<span class="property">conf</span>
mv sites-available/app_collection.<span class="property">local</span>.<span class="property">conf</span> /etc/nginx/sites-available
ln -s /etc/nginx/sites-available/app_collection.<span class="property">local</span>.<span class="property">conf</span> /etc/nginx/sites-enabled
mv nginxconfig.<span class="property">io</span> /etc/nginx/
</code></pre><p>Secondly, now that we have moved the configuration files over, restart nginx:</p><pre><code>service nginx restart
</code></pre><p>::: {.wp-block-embed__wrapper} https://m.youtube.com/watch?v=qUrDtoHI-zw :::</p><p>Most importantly, if you are using a <code>.local</code> host name, make sure to setup the host name on your network. That is to say, make sure the host name is accessible from your local development computer. For instance, on macOS or Linux, you would need to edit <a href="https://en.wikipedia.org/wiki/Hosts_(file">the <code>/etc/hosts</code> file</a>). On the other hand, if this is to be a public host name, verify you have updated your dns accordingly.</p><p>After you have verified the dns or hosts file is updated, we can proceed if testing the application out:</p><pre><code>&gt; curl http://app_collection.<span class="property">local</span>/hello
<span class="type">Hello</span>, world!%
&gt; curl -<span class="type">X POST</span> -<span class="type">H</span> <span class="string">"Content-Type: application/json"</span> -d '{<span class="string">"title"</span>: <span class="string">"example"</span>}' http://app_collection.<span class="property">local</span>/<span class="call">todos</span>
{<span class="string">"id"</span>:<span class="number">1</span>,<span class="string">"title"</span>:<span class="string">"example"</span>}%
&gt; curl http://app_collection.<span class="property">local</span>/todos
[{<span class="string">"id"</span>:<span class="number">1</span>,<span class="string">"title"</span>:<span class="string">"example"</span>}]%
</code></pre><p>In short, we've successfully setup the application on an Ubuntu server.</p><p>::: {#mc<em>embed</em>signup} ::: {#mc<em>embed</em>signup_scroll}</p><h2>Want to Learn More? Get the Full Guide and Video Mini-Course Today</h2><p>::: {.indicates-required} [*]{.asterisk} indicates required :::</p><p>::: {.mc-field-group} Email Address [*]{.asterisk} :::</p><p>::: {.mc-field-group} First Name [*]{.asterisk} :::</p><p>::: {.mc-field-group} Last Name [*]{.asterisk} :::</p><p>::: {.mc-field-group .input-group style="display:none"} - Swift - Productivity - Vapor :::</p><p>::: {.mc-field-group .input-group style="display:none"} <strong>Products</strong></p><ul><li>Speculid :::</li></ul><p>::: {#mergeRow-gdpr .mergeRow .gdpr-mergeRow .content<strong>gdprBlock .mc-field-group} ::: {.content</strong>gdpr} Marketing Permissions</p><p>Please select all the ways you would like to hear from BrightDigit:</p><p>Email</p><p>You can unsubscribe at any time by clicking the link in the footer of our emails. For information about our privacy practices, please visit our website. :::</p><p>::: {.content__gdprLegal} We use Mailchimp as our marketing platform. By clicking below to subscribe, you acknowledge that your information will be transferred to Mailchimp for processing. <a href="https://mailchimp.com/legal/">Learn more about Mailchimp's privacy practices here.</a> ::: :::</p><p>::: {#mce-responses .clear} ::: {#mce-error-response .response style="display:none"} :::</p><p>::: {#mce-success-response .response style="display:none"} ::: :::</p><p>::: {style="position: absolute; left: -5000px;" aria-hidden="true"} :::</p><p>::: {.clear} ::: ::: :::</p><h2>And There's More...</h2><p>In conclusion, we've successfully:</p><ul><li>setup our <strong>Mac for developing</strong> server-side Swift application using Vapor</li><li>converted the beginner template to <strong>use PostgreSQL</strong> from SQLite</li><li>updated the code to <strong>use environment variables</strong> for different server environments</li><li>setup and deployed the application to <strong>Heroku</strong></li><li>setup and deployed to an <strong>Ubuntu</strong> server</li></ul><p>Vapor will will reduce friction in your Swift development and has effective community support. To get a full guide and video mini-course, fill out <a href="http://eepurl.com/gku85T">this form</a> and <strong>let me know what other Vapor topics</strong> you are interested in learning more about such as:</p><ul><li>setting up <strong>complicated database models</strong> and relationships</li><li>how to configure <strong>advanced Rest API routes</strong></li><li>writing <strong>complex queries using Fluent ORM</strong> and Futures in Swift</li><li>setting up for <strong>authentication</strong></li></ul><p>I look forward to hearing your feedback and I'll keep you posted on updates.</p></div>
        <span>Tagged with: </span>
      </article>
    </main>
    <footer>
      <div class="address">5859 W Saginaw #182 Lansing MI 48917</div>
      <div class="copyright">© Bright Digit, LLC 2021</div>
    </footer>
  </body>
</html>